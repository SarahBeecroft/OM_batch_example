#!/bin/bash -l
#SBATCH --job-name=openmalaria
#SBATCH --nodes=1
#SBATCH --cpus-per-task=1
#SBATCH --time=4:00:00
#SBATCH --partition=work
#SBATCH --exclusive
#SBATCH --account=$PAWSEYPROJECT
#SBATCH --mem=0

set -euo pipefail

module load singularity/3.11.4-nompi

# Configuration - UPDATE WITH PATHS TO NECESSARY FILES/INSTALLS
# OM_PATH=
# LOGS_DIR=
# OUTPUT_DIR=

# Calculate batch size based on node capacity
# For work nodes, estimate that 128 jobs can run concurrently
CHUNK_SIZE=128

#===============================#
# Avoid editing below this line #
#===============================#

# Create log and output dirs
mkdir -p ${LOGS_DIR}
mkdir -p ${OUTPUT_DIR}

# Read PARAMS list
mapfile -t PARAMS < $PARAMS_LIST

PARAMS_ARRAY=("${PARAMS[@]}")
TOTAL_PARAMS=${#PARAMS_ARRAY[@]}

echo "Processing ${TOTAL_PARAMS} params in chunks of ${CHUNK_SIZE}..."

# Process params in chunks of 128 at a time
for ((i=0; i<${TOTAL_PARAMS}; i+=CHUNK_SIZE)); do
    BATCH_NUM=$((i/BATCH_SIZE + 1))
    echo "Starting batch ${BATCH_NUM}..."
    
    # Launch one batch of PARAMs
    for ((j=i; j<i+BATCH_SIZE && j<${TOTAL_PARAMS}; j++)); do
        PARAM=${PARAMS_ARRAY[$j]}
        echo "Launching param ${PARAM} ($(($j+1))/${TOTAL_PARAMS})" \        
        srun --nodes=1 \
            --ntasks=1 \
            --cpus-per-task=1 \
            --mem=2GB \
            --output=${LOGS_DIR}/%j_${PARAM}.log \
            --error=${LOGS_DIR}/%j_${PARAM}.log \
            bash -c "
            echo 'Processing param ${PARAM}' && \
            OM CODE GOES HERE && \
            echo 'OM completed for param ${PARAM}' 
            " &
    done
    
    # Wait for this batch to complete before starting next
    echo "  Waiting for batch ${BATCH_NUM} to complete..."
    wait
    echo "  Batch ${BATCH_NUM} complete!"
done

# Quick summary
echo "Summary:"
echo "  Total params: ${TOTAL_PARAMS}"
